@model List<WorkTrace.WebApp.Models.ServiceViewModel>

@{
    ViewData["Title"] = "Servicios";
}

<style>
    .services-container {
        background: #f9fafb;
        min-height: 100vh;
        padding: 2rem 0;
    }

    .service-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        overflow: hidden;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .service-card:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-4px);
    }

    .service-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem;
        position: relative;
    }

    .service-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .service-description {
        font-size: 1rem;
        opacity: 0.95;
        line-height: 1.5;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .edit-icon {
        cursor: pointer;
        padding: 0.4rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .edit-icon:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .service-body {
        padding: 2rem;
    }

    .steps-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .steps-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .step-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f9fafb;
        border-radius: 12px;
        border-left: 4px solid #10b981;
        transition: all 0.2s ease;
        position: relative;
    }

    .step-item:hover {
        background: #f0fdf4;
        transform: translateX(4px);
    }

    .step-number {
        background: #10b981;
        color: white;
        min-width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .step-description {
        flex: 1;
        color: #4b5563;
        font-size: 0.95rem;
        line-height: 1.6;
        padding-top: 0.25rem;
    }

    .step-edit-icon {
        cursor: pointer;
        color: #6b7280;
        padding: 0.4rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .step-edit-icon:hover {
        background: #e5e7eb;
        color: #10b981;
        transform: scale(1.1);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        color: #d1d5db;
    }

    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background-color: #10b981;
        color: white;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .back-button:hover {
        background-color: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        color: white;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #111827;
    }

    .error-message {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #dc2626;
    }

    .success-message {
        background-color: #d1fae5;
        color: #065f46;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #10b981;
    }

    .no-steps {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
        font-style: italic;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.2s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
        animation: slideDown 0.3s ease;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .modal-close {
        cursor: pointer;
        color: #6b7280;
        font-size: 1.5rem;
        font-weight: 700;
        transition: color 0.2s ease;
    }

    .modal-close:hover {
        color: #111827;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary {
        background-color: #10b981;
        color: white;
    }

    .btn-primary:hover {
        background-color: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-secondary {
        background-color: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background-color: #d1d5db;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
</style>

<div class="services-container">
    <div class="container mx-auto px-4">
        <div class="header-section">
            <h1 class="page-title">Nuestros Servicios</h1>
            <div style="display: flex; align-items: center;">
                <button class="btn btn-primary" onclick="openCreateServiceModal()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                    </svg>
                    Crear Servicio
                </button>
                <a asp-controller="Home" asp-action="Index" class="back-button" style="margin-left: 1rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                    </svg>
                    Volver al Panel
                </a>
            </div>
        </div>

        <div id="successMessage" class="success-message" style="display: none;">
            <strong>Éxito:</strong> <span id="successText"></span>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <strong>Error:</strong> <span id="errorText"></span>
        </div>

        @if (!string.IsNullOrEmpty(ViewBag.Error))
        {
            <div class="error-message">
                <strong>Error:</strong> @ViewBag.Error
            </div>
        }

        @if (Model != null && Model.Any())
        {
            @foreach (var service in Model)
            {
                <div class="service-card" data-service-id="@service.Id">
                    <div class="service-header">
                        <h2 class="service-title">
                            <span class="service-name-text">@service.Name</span>
                            <span class="edit-icon" onclick="editService('@service.Id', '@service.Name', '@service.Description')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                            </span>
                        </h2>
                        <p class="service-description">
                            <span class="service-desc-text">@service.Description</span>
                        </p>
                    </div>

                    <div class="service-body">
                        <h3 class="steps-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                            </svg>
                            Pasos de Instalación
                        </h3>

                        @if (service.InstallationSteps != null && service.InstallationSteps.Any())
                        {
                            <ul class="steps-list">
                                @foreach (var step in service.InstallationSteps)
                                {
                                    <li class="step-item" data-step-id="@step.Id">
                                        <div class="step-number">@step.Steps</div>
                                        <div class="step-description">@step.Description</div>
                                        <span class="step-edit-icon" onclick="editStep('@step.Id', @step.Steps, '@step.Description')">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                            </svg>
                                        </span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div class="no-steps">
                                No hay pasos de instalación registrados para este servicio.
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" class="empty-state-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                    <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                </svg>
                <h3 class="text-2xl font-semibold mb-2 text-gray-700">No hay servicios disponibles</h3>
                <p class="text-gray-600">No se encontraron servicios registrados en el sistema.</p>
            </div>
        }
    </div>
</div>

<!-- Modal for Creating Service -->
<div id="createServiceModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Crear Nuevo Servicio</h3>
            <span class="modal-close" onclick="closeCreateServiceModal()">&times;</span>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="createServiceForm">
                <div class="form-group">
                    <label class="form-label" for="createServiceName">Nombre del Servicio</label>
                    <input type="text" id="createServiceName" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="createServiceDescription">Descripción</label>
                    <textarea id="createServiceDescription" class="form-input" rows="3" required></textarea>
                </div>
                <hr class="my-4"/>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="steps-title" style="margin-bottom: 0;">Pasos de Instalación</h4>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addStepInput()">Añadir Paso</button>
                </div>
                <div id="installationStepsContainer">
                    <!-- Dynamic steps will be inserted here -->
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateServiceModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="createService()">Crear Servicio</button>
        </div>
    </div>
</div>

<!-- Modal for Editing Service -->
<div id="serviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Editar Servicio</h3>
            <span class="modal-close" onclick="closeServiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="serviceForm">
                <input type="hidden" id="serviceId" />
                <div class="form-group">
                    <label class="form-label" for="serviceName">Nombre del Servicio</label>
                    <input type="text" id="serviceName" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="serviceDescription">Descripción</label>
                    <textarea id="serviceDescription" class="form-input" rows="4" required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeServiceModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveService()">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal for Editing Installation Step -->
<div id="stepModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Editar Paso de Instalación</h3>
            <span class="modal-close" onclick="closeStepModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="stepForm">
                <input type="hidden" id="stepId" />
                <div class="form-group">
                    <label class="form-label" for="stepNumber">Número de Paso</label>
                    <input type="number" id="stepNumber" class="form-input" min="1" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="stepDescription">Descripción del Paso</label>
                    <textarea id="stepDescription" class="form-input" rows="4" required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStepModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveStep()">Guardar Cambios</button>
        </div>
    </div>
</div>

<script>
    let stepCounter = 0;

    // Create Service Modal Functions
    function openCreateServiceModal() {
        document.getElementById('createServiceModal').classList.add('show');
        addStepInput(); // Add one step by default
    }

    function closeCreateServiceModal() {
        document.getElementById('createServiceModal').classList.remove('show');
        document.getElementById('createServiceForm').reset();
        document.getElementById('installationStepsContainer').innerHTML = '';
        stepCounter = 0;
    }

    function addStepInput() {
        stepCounter++;
        const container = document.getElementById('installationStepsContainer');
        const stepInput = document.createElement('div');
        stepInput.classList.add('form-group', 'd-flex', 'align-items-center');
        stepInput.style.gap = '10px';
        stepInput.setAttribute('id', `step-group-${stepCounter}`);
        
        const stepNumber = document.createElement('strong');
        stepNumber.className = 'step-counter';
        stepNumber.textContent = `${stepCounter}.`;

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-input';
        input.placeholder = 'Descripción del paso';
        input.required = true;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger btn-sm';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeStepInput(stepCounter);

        stepInput.appendChild(stepNumber);
        stepInput.appendChild(input);
        stepInput.appendChild(removeBtn);
        container.appendChild(stepInput);
    }

    function removeStepInput(stepId) {
        const stepGroup = document.getElementById(`step-group-${stepId}`);
        if (stepGroup) {
            stepGroup.remove();
            // Re-number the steps
            const container = document.getElementById('installationStepsContainer');
            const steps = container.querySelectorAll('.step-counter');
            steps.forEach((step, index) => {
                step.textContent = `${index + 1}.`;
            });
            stepCounter = steps.length;
        }
    }

    async function createService() {
        const name = document.getElementById('createServiceName').value;
        const description = document.getElementById('createServiceDescription').value;
        
        if (!name || !description) {
            showError('Por favor complete el nombre y la descripción del servicio.');
            return;
        }

        const stepsContainer = document.getElementById('installationStepsContainer');
        const stepInputs = stepsContainer.querySelectorAll('input[type="text"]');
        const installationSteps = [];
        let allStepsValid = true;

        stepInputs.forEach((input, index) => {
            if (!input.value) {
                allStepsValid = false;
            }
            installationSteps.push({
                steps: index + 1,
                description: input.value
            });
        });

        if (!allStepsValid) {
            showError('Por favor complete la descripción de todos los pasos de instalación.');
            return;
        }

        if (installationSteps.length === 0) {
            showError('Debe agregar al menos un paso de instalación.');
            return;
        }

        const serviceData = {
            name,
            description,
            installationSteps
        };

        const button = event.target;
        button.classList.add('loading');
        button.textContent = 'Creando...';

        try {
            const response = await fetch('@Url.Action("CreateService", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(serviceData)
            });

            if (response.ok) {
                showSuccess('Servicio creado correctamente. La página se recargará.');
                closeCreateServiceModal();
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    let errorMessage = "Error al crear el servicio.";
                    if (errorData && errorData.errors) {
                        errorMessage = Object.values(errorData.errors).flat().join(' ');
                    }
                    showError(errorMessage);
                } catch (e) {
                    showError(errorText || 'Error al procesar la respuesta del servidor.');
                }
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        } finally {
            button.classList.remove('loading');
            button.textContent = 'Crear Servicio';
        }
    }

    // Service Modal Functions
    function editService(id, name, description) {
        document.getElementById('serviceId').value = id;
        document.getElementById('serviceName').value = name;
        document.getElementById('serviceDescription').value = description;
        document.getElementById('serviceModal').classList.add('show');
    }

    function closeServiceModal() {
        document.getElementById('serviceModal').classList.remove('show');
    }

    async function saveService() {
        const id = document.getElementById('serviceId').value;
        const name = document.getElementById('serviceName').value;
        const description = document.getElementById('serviceDescription').value;

        if (!name || !description) {
            showError('Por favor complete todos los campos');
            return;
        }

        const button = event.target;
        button.classList.add('loading');
        button.textContent = 'Guardando...';

        try {
            const response = await fetch('@Url.Action("UpdateService", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, name, description })
            });

            if (response.ok) {
                showSuccess('Servicio actualizado correctamente');
                closeServiceModal();

                // Update UI without reloading
                const card = document.querySelector(`[data-service-id="${id}"]`);
                if (card) {
                    card.querySelector('.service-name-text').textContent = name;
                    card.querySelector('.service-desc-text').textContent = description;
                }
            } else {
                showError('Error al actualizar el servicio');
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        } finally {
            button.classList.remove('loading');
            button.textContent = 'Guardar Cambios';
        }
    }

    // Step Modal Functions
    function editStep(id, stepNumber, description) {
        // Escape single quotes in description
        description = description.replace(/'/g, "\\'");
        document.getElementById('stepId').value = id;
        document.getElementById('stepNumber').value = stepNumber;
        document.getElementById('stepDescription').value = description;
        document.getElementById('stepModal').classList.add('show');
    }

    function closeStepModal() {
        document.getElementById('stepModal').classList.remove('show');
    }

    async function saveStep() {
        const id = document.getElementById('stepId').value;
        const steps = parseInt(document.getElementById('stepNumber').value);
        const description = document.getElementById('stepDescription').value;

        if (!steps || !description) {
            showError('Por favor complete todos los campos');
            return;
        }

        const button = event.target;
        button.classList.add('loading');
        button.textContent = 'Guardando...';

        try {
            const response = await fetch('@Url.Action("UpdateInstallationStep", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, steps, description })
            });

            if (response.ok) {
                showSuccess('Paso de instalación actualizado correctamente');
                closeStepModal();

                // Update UI without reloading
                const stepItem = document.querySelector(`[data-step-id="${id}"]`);
                if (stepItem) {
                    stepItem.querySelector('.step-number').textContent = steps;
                    stepItem.querySelector('.step-description').textContent = description;
                }
            } else {
                showError('Error al actualizar el paso de instalación');
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        } finally {
            button.classList.remove('loading');
            button.textContent = 'Guardar Cambios';
        }
    }

    // Utility Functions
    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        document.getElementById('successText').textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 5000);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const serviceModal = document.getElementById('serviceModal');
        const stepModal = document.getElementById('stepModal');

        if (event.target === serviceModal) {
            closeServiceModal();
        }
        if (event.target === stepModal) {
            closeStepModal();
        }
    }
</script>
