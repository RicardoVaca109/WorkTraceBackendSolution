@model List<WorkTrace.Application.DTOs.UserDTO.Information.UserInformationResponse>
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Empleados";
    var apiUrl = Configuration.GetValue<string>("APIConfigurations:ApiUrl");
}

<style>
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        background-color: #6c757d;
        color: white;
        border-radius: 0.25rem;
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .back-button:hover {
        background-color: #5a6268;
        color: white;
    }
</style>

<div class="max-w-7xl mx-auto mt-10 px-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Lista de Empleados</h2>
        <div style="display: flex; align-items: center;">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openCreateUserModal()">
                <i class="bi bi-plus-lg"></i> Agregar Empleado
            </button>
            <a asp-controller="Home" asp-action="Index" class="back-button" style="margin-left: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                </svg>
                Volver al Panel
            </a>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <p class="text-gray-600">No hay empleados registrados.</p>
    }
    else
    {
        <div class="overflow-x-auto shadow rounded-lg">
            <table class="min-w-full border border-gray-200 text-left">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 border-b">Nombre Completo</th>
                        <th class="px-4 py-2 border-b">Email</th>
                        <th class="px-4 py-2 border-b">Rol</th>
                        <th class="px-4 py-2 border-b">Teléfono</th>
                        <th class="px-4 py-2 border-b">Documento</th>
                        <th class="px-4 py-2 border-b">Estado</th>
                        <th class="px-4 py-2 border-b">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var emp in Model)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border-b">@emp.FullName</td>
                            <td class="px-4 py-2 border-b">@emp.Email</td>
                            <td class="px-4 py-2 border-b">@GetRoleSpanish(emp.Role)</td>
                            <td class="px-4 py-2 border-b">@emp.PhoneNumber</td>
                            <td class="px-4 py-2 border-b">@emp.DocumentNumber</td>
                            <td class="px-4 py-2 border-b">
                                <span class="badge @(emp.IsActive ? "bg-success" : "bg-secondary")">
                                    @(emp.IsActive ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td class="px-4 py-2 border-b">
                                <button class="btn btn-sm btn-primary" onclick="openEditUserModal('@emp.Email')">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Agregar Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <div class="modal-body">
                    <input type="hidden" id="userEmail" />

                    <div class="mb-3">
                        <label for="fullName" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" placeholder="Dejar en blanco para mantener">
                    </div>

                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="phoneNumber" required>
                    </div>

                    <div class="mb-3">
                        <label for="documentNumber" class="form-label">Documento</label>
                        <input type="text" class="form-control" id="documentNumber" required>
                    </div>

                    <div class="mb-3">
                        <label for="role" class="form-label">Rol</label>
                        <select class="form-select" id="role" required>
                            <option value="">Seleccionar Rol</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Técnico">Técnico</option>
                            <option value="Vendedor">Vendedor</option>
                        </select>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Empleado Activo
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const apiUrl = '@Html.Raw(apiUrl)';
        const token = '@Html.Raw(Context.Session.GetString("JWToken") ?? "")';
        const usersData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));

        function openCreateUserModal() {
            document.getElementById('userForm').reset();
            document.getElementById('userEmail').value = '';
            document.getElementById('password').required = true;
            document.getElementById('password').value = '';
            document.getElementById('email').disabled = false;
            document.getElementById('userModalLabel').textContent = 'Agregar Empleado';

            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        function openEditUserModal(email) {
            try {
                const selectedUser = usersData.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());

                if (selectedUser) {
                    document.getElementById('userEmail').value = email;
                    document.getElementById('fullName').value = selectedUser.fullName || '';
                    document.getElementById('email').value = email;
                    // document.getElementById('email').disabled = true;
                    document.getElementById('password').required = false;
                    document.getElementById('password').value = '';
                    document.getElementById('password').placeholder = 'Dejar en blanco para mantener la contraseña';
                    document.getElementById('phoneNumber').value = selectedUser.phoneNumber || '';
                    document.getElementById('documentNumber').value = selectedUser.documentNumber || '';
                    // Convert numeric role value to Spanish role name
                    document.getElementById('role').value = getRoleNameFromEnum(selectedUser.role) || '';
                    document.getElementById('isActive').checked = selectedUser.isActive || false;
                    document.getElementById('userModalLabel').textContent = 'Editar Empleado';

                    const modal = new bootstrap.Modal(document.getElementById('userModal'));
                    modal.show();
                } else {
                    console.warn('Usuario no encontrado:', email);
                    console.warn('Usuarios disponibles:', usersData);
                    alert('No se encontró el empleado seleccionado');
                }
            } catch (error) {
                console.error('Error al abrir modal de edición:', error);
                console.error('Datos de usuarios:', usersData);
                alert('Error al cargar los datos del empleado');
            }
        }

        // Map role names to enum numeric values
        const roleMapping = {
            'Administrador': 0,
            'Técnico': 1,
            'Vendedor': 2
        };

        // Reverse mapping: convert numeric enum values to role names
        const reverseRoleMapping = {
            0: 'Administrador',
            1: 'Técnico',
            2: 'Vendedor'
        };

        function getRoleEnumValue(roleName) {
            return roleMapping[roleName] !== undefined ? roleMapping[roleName] : null;
        }

        function getRoleNameFromEnum(roleValue) {
            return reverseRoleMapping[roleValue] || '';
        }

        function saveUser(event) {
            event.preventDefault();

            const userEmail = document.getElementById('userEmail').value;
            const isEdit = userEmail !== '';
            const passwordValue = document.getElementById('password').value;
            const roleValue = document.getElementById('role').value;

            // Validate required fields
            if (!roleValue) {
                alert('Por favor selecciona un rol válido');
                return;
            }

            if (!isEdit && !passwordValue) {
                alert('La contraseña es requerida para crear un nuevo empleado');
                return;
            }

            // Get role enum numeric value
            const roleEnumValue = getRoleEnumValue(roleValue);
            if (roleEnumValue === null) {
                alert('Rol inválido seleccionado');
                return;
            }

            // Build request object with proper field names
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const documentNumber = document.getElementById('documentNumber').value;
            const isActive = document.getElementById('isActive').checked;

            let requestPayload;
            let url;
            let method;

            if (isEdit) {
                // For Update: send as flat structure
                requestPayload = {
                    fullName: fullName || null,
                    email: email || null,
                    phoneNumber: phoneNumber || null,
                    documentNumber: documentNumber || null,
                    role: roleEnumValue,
                    isActive: isActive
                };

                // Only add password if provided
                if (passwordValue) {
                    requestPayload.password = passwordValue;
                }

                url = `${apiUrl}User/Update?id=${userEmail}`;
                method = 'PUT';
            } else {
                // For Create: send as flat structure
                requestPayload = {
                    fullName: fullName,
                    email: email,
                    phoneNumber: phoneNumber,
                    documentNumber: documentNumber,
                    password: passwordValue,
                    role: roleEnumValue,
                    isActive: isActive
                };

                url = `${apiUrl}User/Create`;
                method = 'POST';
            }

            console.log('Enviando datos:', requestPayload);
            console.log('URL:', url);
            console.log('Método:', method);

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestPayload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error(text || 'Error al guardar el empleado');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(isEdit ? 'Empleado actualizado correctamente' : 'Empleado creado correctamente');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar el empleado: ' + error.message);
            });
        }

        // Handle modal cleanup when hidden
        const userModal = document.getElementById('userModal');
        userModal.addEventListener('hidden.bs.modal', function() {
            // Remove any lingering backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Ensure body scrollbar is restored
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });

    </script>
}

@functions {
    private string GetRoleSpanish(WorkTrace.Application.Enums.UserRoles role)
    {
        return role switch
        {
            WorkTrace.Application.Enums.UserRoles.Administrador => "Administrador",
            WorkTrace.Application.Enums.UserRoles.Técnico => "Técnico",
            WorkTrace.Application.Enums.UserRoles.Vendedor => "Vendedor",
            _ => role.ToString()
        };
    }
}

